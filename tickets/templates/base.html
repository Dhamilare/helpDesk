{% load static %}
{% load widget_tweaks %} {# We'll need this to apply Tailwind classes to form fields #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Helpdesk System{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    {# Lucide Icons CDN - Using unpkg as a workaround for jsdelivr issues #}
    <script src="https://unpkg.com/lucide@latest"></script> 

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans antialiased">
<div class="flex flex-1">

    <!-- Sidebar -->
    <aside id="main-sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 
           fixed inset-y-0 left-0 transform -translate-x-full 
           md:relative md:translate-x-0 md:flex md:flex-col
           transition-transform duration-200 ease-in-out z-30 shadow-lg">
        <div class="flex items-center px-4 mb-6">
            <a class="text-white text-2xl font-semibold hover:text-gray-200 transition-colors" href="{% url 'dashboard' %}">
                <i data-lucide="headset" class="inline-block h-7 w-7 mr-2"></i> Helpdesk
            </a>
        </div>
        <nav class="flex-1">
            <ul class="space-y-2">
                {% if user.is_authenticated %}
                    <li><a href="{% url 'dashboard' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700"> <i data-lucide="layout-dashboard" class="mr-3 h-5 w-5"></i> Dashboard </a></li>
                    <li><a href="{% url 'ticket_list' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700"> <i data-lucide="ticket" class="mr-3 h-5 w-5"></i> Tickets </a></li>
                    <li><a href="{% url 'ticket_create' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700"> <i data-lucide="plus-circle" class="mr-3 h-5 w-5"></i> Create Ticket </a></li>
                    <li><a href="{% url 'kb_list' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700"> <i data-lucide="book-open" class="mr-3 h-5 w-5"></i> Knowledge Base </a></li>
                    {% if user.userprofile.is_agent or user.userprofile.is_supervisor %}
                        <li><a href="{% url 'reports' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700"> <i data-lucide="bar-chart-2" class="mr-3 h-5 w-5"></i> Reports </a></li>
                    {% endif %}
                {% endif %}
            </ul>
        </nav>
        <div class="mt-auto pt-6 border-t border-gray-700 px-4">
            {% if user.is_authenticated %}
                {# Link to open the profile modal #}
                <button id="openProfileModal" class="w-full text-left py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700 mb-2 flex items-center">
                    <i data-lucide="user-circle" class="mr-3 h-5 w-5"></i> Hello, {{ user.username }}
                </button>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" id="logout-button" class="w-full text-left py-2 px-4 rounded-lg text-gray-300 hover:bg-red-700 hover:text-white flex items-center">
                        <i data-lucide="log-out" class="mr-3 h-5 w-5"></i> Logout
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-blue-700 mb-2"> <i data-lucide="log-in" class="mr-3 h-5 w-5"></i> Login </a>
                <a href="{% url 'register' %}" class="sidebar-link group flex items-center py-2 px-4 rounded-lg text-gray-300 hover:bg-green-700"> <i data-lucide="user-plus" class="mr-3 h-5 w-5"></i> Register </a>
            {% endif %}
        </div>
    </aside>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <!-- Content Area -->
    <div class="flex-1 flex flex-col min-h-screen">
        <!-- Mobile Header -->
        <header id="main-header" class="bg-white shadow-sm p-4 flex items-center justify-between md:hidden z-40">
            <button id="sidebar-toggle" class="text-gray-600 hover:text-gray-900 focus:outline-none">
                <i data-lucide="menu" class="h-6 w-6"></i>
            </button>
            <div class="text-lg font-semibold text-gray-800">Helpdesk</div>
            {% if user.is_authenticated %}
                <div class="flex items-center space-x-2">
                    <i data-lucide="user-circle" class="h-6 w-6 text-gray-600"></i>
                    <span class="text-gray-800 text-sm">{{ user.username }}</span>
                </div>
            {% endif %}
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for message in messages %}
                        <div class="p-4 rounded-lg shadow-sm flex items-center justify-between
                                     {% if message.tags == 'success' %}bg-green-100 text-green-800
                                     {% elif message.tags == 'error' %}bg-red-100 text-red-800
                                     {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800
                                     {% else %}bg-blue-100 text-blue-800{% endif %}">
                            <p>{{ message }}</p>
                            <button type="button" class="text-current opacity-75 hover:opacity-100" onclick="this.parentElement.remove();">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Profile Edit Modal -->
<div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
        <div class="flex justify-between items-center pb-3 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Edit Profile</h3>
            <button type="button" id="closeProfileModal" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        <form method="post" action="{% url 'profile' %}" class="mt-4 space-y-4">
            {% csrf_token %}
            
            {# Display non-field errors for the profile form #}
            {% if profile_form.non_field_errors %}
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-2 rounded-md text-sm">
                    {% for error in profile_form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            {# User fields (first_name, last_name, email) #}
            <div>
                <label for="{{ profile_form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700">First Name</label>
                {{ profile_form.first_name|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.first_name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>
            <div>
                <label for="{{ profile_form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Last Name</label>
                {{ profile_form.last_name|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.last_name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>
            <div>
                <label for="{{ profile_form.email.id_for_label }}" class="block text-sm font-medium text-gray-700">Email</label>
                {{ profile_form.email|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.email.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>

            {# UserProfile fields (department, phone, job_title) #}
            <div>
                <label for="{{ profile_form.department.id_for_label }}" class="block text-sm font-medium text-gray-700">Department</label>
                {{ profile_form.department|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.department.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>
            <div>
                <label for="{{ profile_form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700">Phone</label>
                {{ profile_form.phone|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.phone.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>
            <div>
                <label for="{{ profile_form.job_title.id_for_label }}" class="block text-sm font-medium text-gray-700">Job Title</label>
                {{ profile_form.job_title|add_class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" }}
                {% for error in profile_form.job_title.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="mt-6 flex justify-end">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i data-lucide="save" class="h-4 w-4 mr-2"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Spinner -->
<div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
    <style>
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</div>

<!-- Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Lucide icons
        lucide.createIcons();

        // Sidebar toggle logic
        const sidebar = document.getElementById('main-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggle = document.getElementById('sidebar-toggle');

        if (toggle) { // Check if toggle button exists (it won't on desktop)
            toggle.addEventListener('click', () => {
                const isOpen = sidebar.classList.contains('translate-x-0');
                if (isOpen) {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    overlay.classList.remove('hidden');
                }
            });
        }

        if (overlay) {
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.add('hidden');
            }
        });

        // Profile Modal Logic
        const profileModal = document.getElementById('profileModal');
        const openProfileModalBtn = document.getElementById('openProfileModal');
        const closeProfileModalBtn = document.getElementById('closeProfileModal');

        if (openProfileModalBtn) {
            openProfileModalBtn.addEventListener('click', () => {
                profileModal.classList.remove('hidden');
            });
        }

        if (closeProfileModalBtn) {
            closeProfileModalBtn.addEventListener('click', () => {
                profileModal.classList.add('hidden');
            });
        }

        // Close modal if clicked outside
        if (profileModal) {
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    profileModal.classList.add('hidden');
                }
            });
        }
    });
</script>

<script src="{% static 'js/main.js' %}"></script>
{% block extra_js %}{% endblock %}
</body>
</html>