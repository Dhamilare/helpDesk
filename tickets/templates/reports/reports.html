{% extends 'base.html' %}
{% load static %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-gray-50 to-blue-100 font-sans antialiased"> {# Added background gradient, min-height, and font styling #}
    <h2 class="text-4xl font-extrabold text-gray-900 mb-8 tracking-tight text-center">Reports and Analytics</h2> {# Larger, bolder title, centered #}
    <div class="w-24 h-1 bg-blue-500 rounded-full mx-auto mb-10"></div> {# Modernized HR with a colored line #}

    <div class="bg-white rounded-xl shadow-lg p-8 mb-10 transform transition duration-300 hover:shadow-xl"> {# Enhanced card styling for filter form #}
        <form method="get" class="flex flex-col md:flex-row items-end md:items-center space-y-4 md:space-y-0 md:space-x-4"> {# Align items to center vertically #}
            <div class="w-full md:w-1/4">
                <label for="id_date_from" class="block text-sm font-medium text-gray-700 mb-2">Date From</label> {# Improved label spacing #}
                <input type="date" name="date_from" id="id_date_from"
                       class="block w-full px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 sm:text-base transition duration-200 ease-in-out" {# Added padding, softer ring, transition #}
                       value="{{ date_from|date:'Y-m-d' }}">
            </div>
            <div class="w-full md:w-1/4">
                <label for="id_date_to" class="block text-sm font-medium text-gray-700 mb-2">Date To</label> {# Improved label spacing #}
                <input type="date" name="date_to" id="id_date_to"
                       class="block w-full px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 sm:text-base transition duration-200 ease-in-out" {# Added padding, softer ring, transition #}
                       value="{{ date_to|date:'Y-m-d' }}">
            </div>
            <div class="flex items-center space-x-4 mt-auto"> {# Added mt-auto to push buttons to the bottom of the flex container #}
                <button type="submit"
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-semibold rounded-lg shadow-md text-white
                               bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-white
                               transform transition-all duration-300 ease-in-out hover:scale-105"> {# Gradient button, larger padding, stronger hover #}
                    <i data-lucide="filter" class="h-5 w-5 mr-3"></i> Apply Date Filter {# Larger icon, more margin #}
                </button>
                <a href="{% url 'reports' %}"
                   class="inline-flex items-center px-6 py-3 text-base font-semibold rounded-lg shadow-md text-gray-700 bg-white border border-gray-300
                          hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 focus:ring-offset-white
                          transform transition-all duration-300 ease-in-out hover:scale-105"> {# Larger padding, stronger hover #}
                    <i data-lucide="refresh-cw" class="h-5 w-5 mr-3"></i> Reset Dates {# Larger icon, more margin #}
                </a>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        {# Metric Cards #}
        <div class="bg-blue-600 rounded-xl shadow-lg p-7 text-white flex items-center justify-between transform transition-all duration-300 hover:scale-105 hover:shadow-xl"> {# Softer corners, stronger shadow, hover effect #}
            <div>
                <h5 class="text-lg font-medium opacity-95">Total Tickets</h5> {# Slightly more opaque #}
                <p class="text-5xl font-extrabold mt-3">{{ total_tickets }}</p> {# Larger, bolder number #}
            </div>
            <i data-lucide="ticket" class="h-14 w-14 opacity-85"></i> {# Larger icon, more opaque #}
        </div>
        <div class="bg-green-600 rounded-xl shadow-lg p-7 text-white flex items-center justify-between transform transition-all duration-300 hover:scale-105 hover:shadow-xl">
            <div>
                <h5 class="text-lg font-medium opacity-95">Resolved Tickets</h5>
                <p class="text-5xl font-extrabold mt-3">{{ resolved_tickets }}</p>
            </div>
            <i data-lucide="check-circle" class="h-14 w-14 opacity-85"></i>
        </div>
        <div class="bg-gray-600 rounded-xl shadow-lg p-7 text-white flex items-center justify-between transform transition-all duration-300 hover:scale-105 hover:shadow-xl">
            <div>
                <h5 class="text-lg font-medium opacity-95">Closed Tickets</h5>
                <p class="text-5xl font-extrabold mt-3">{{ closed_tickets }}</p>
            </div>
            <i data-lucide="folder-check" class="h-14 w-14 opacity-85"></i>
        </div>
        <div class="bg-red-600 rounded-xl shadow-lg p-7 text-white flex items-center justify-between transform transition-all duration-300 hover:scale-105 hover:shadow-xl">
            <div>
                <h5 class="text-lg font-medium opacity-95">Overdue Tickets</h5>
                <p class="text-5xl font-extrabold mt-3">{{ overdue_tickets }}</p>
            </div>
            <i data-lucide="clock" class="h-14 w-14 opacity-85"></i>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        {# Resolution Rate Card #}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden transform transition-all duration-300 hover:shadow-xl">
            <div class="bg-gray-50 px-8 py-5 border-b border-gray-200"> {# Lighter header background, more padding #}
                <h5 class="text-lg font-semibold text-gray-700">Resolution Rate</h5>
            </div>
            <div class="p-8 text-center"> {# More padding #}
                <p class="text-6xl font-extrabold text-blue-700">{{ resolution_rate }}<span class="text-4xl ml-1">%</span></p> {# Larger, bolder text, adjusted % size #}
            </div>
        </div>
        {# Average Resolution Time Card #}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden transform transition-all duration-300 hover:shadow-xl">
            <div class="bg-gray-50 px-8 py-5 border-b border-gray-200"> {# Lighter header background, more padding #}
                <h5 class="text-lg font-semibold text-gray-700">Average Resolution Time</h5>
            </div>
            <div class="p-8 text-center"> {# More padding #}
                <p class="text-6xl font-extrabold text-green-700"> {# Larger, bolder text #}
                    {% if avg_resolution_time %}
                        {{ avg_resolution_time }} <span class="text-4xl ml-1">hours</span> {# Adjusted hours size #}
                    {% else %}
                        N/A
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {# Tickets by Department Chart #}
        <div class="bg-white rounded-xl shadow-lg p-8"> {# Consistent card styling #}
            <h3 class="text-xl font-bold text-gray-800 mb-6">Tickets by Department</h3> {# Bolder title, more margin #}
            <div class="relative w-full h-80">
                <canvas id="deptChart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
        </div>
        {# Tickets by Priority Chart #}
        <div class="bg-white rounded-xl shadow-lg p-8"> {# Consistent card styling #}
            <h3 class="text-xl font-bold text-gray-800 mb-6">Tickets by Priority</h3> {# Bolder title, more margin #}
            <div class="relative w-full h-80">
                <canvas id="priorityChart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        {# Tickets by Status Chart #}
        <div class="bg-white rounded-xl shadow-lg p-8"> {# Consistent card styling #}
            <h3 class="text-xl font-bold text-gray-800 mb-6">Tickets by Status</h3> {# Bolder title, more margin #}
            <div class="relative w-full h-80">
                <canvas id="statusChart" class="absolute inset-0 w-full h-full"></canvas>
            </div>
        </div>
        {# Top 10 Agents by Resolved Tickets List #}
        <div class="bg-white rounded-xl shadow-lg p-8"> {# Consistent card styling #}
            <h3 class="text-xl font-bold text-gray-800 mb-6">Top 10 Agents by Resolved Tickets</h3> {# Bolder title, more margin #}
            {% if agent_stats %}
                <ul class="divide-y divide-gray-100 border-t border-b border-gray-100"> {# Lighter dividers #}
                    {% for stat in agent_stats %}
                        <li class="flex justify-between items-center py-4 px-2 hover:bg-gray-50 transition duration-150 rounded-md"> {# More padding, subtle hover effect #}
                            <span class="text-gray-800 font-semibold text-lg">{{ stat.assigned_to__first_name }} {{ stat.assigned_to__last_name }}</span> {# Stronger text #}
                            <span class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 shadow-sm">{{ stat.count }}</span> {# More padding, stronger badge #}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-600 py-4 text-center">No agent resolution data available.</p> {# Centered message #}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script> {# Ensure correct Lucide CDN #}
<script>
    lucide.createIcons();

    // Your existing Chart.js data and configurations remain unchanged
    const deptLabels = [{% for stat in dept_stats %}'{{ stat.department__name|default:"N/A" }}',{% endfor %}];
    const deptData = [{% for stat in dept_stats %}{{ stat.count }},{% endfor %}];

    const priorityLabels = [{% for stat in priority_stats %}'{{ stat.priority__name }}',{% endfor %}];
    const priorityData = [{% for stat in priority_stats %}{{ stat.count }},{% endfor %}];
    const priorityColors = [{% for stat in priority_stats %}'{{ stat.priority__color }}',{% endfor %}];

    const statusLabels = [{% for stat in status_stats %}'{{ stat.status|capfirst }}',{% endfor %}];
    const statusData = [{% for stat in status_stats %}{{ stat.count }},{% endfor %}];
    const statusColors = ['#FCD34D', '#67E8F9', '#86EFAC', '#D1D5DB', '#FCA5A5']; // Example colors (you might want to customize these if your statuses have specific meanings)

    new Chart(document.getElementById('deptChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: deptLabels,
            datasets: [{
                label: 'Tickets by Department',
                data: deptData,
                backgroundColor: 'rgba(75, 192, 192, 0.7)', // Slightly more opaque
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                borderRadius: 4 // Rounded bars
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { grid: { display: false } }, // Remove vertical grid lines
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 },
                    grid: { color: '#e5e7eb' } // Lighter grid lines
                }
            },
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Tickets by Department',
                    font: { size: 18, weight: 'bold' }, // Larger, bolder title
                    color: '#1f2937' // Darker text color
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)', // Darker tooltip
                    bodyColor: '#fff',
                    titleColor: '#fff'
                }
            }
        }
    });

    new Chart(document.getElementById('priorityChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: priorityLabels,
            datasets: [{
                data: priorityData,
                backgroundColor: priorityColors,
                borderColor: '#ffffff',
                borderWidth: 3 // Slightly thicker border for slices
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { font: { size: 13 }, color: '#374151', padding: 15 } // Larger font, more padding for legend items
                },
                title: {
                    display: true,
                    text: 'Ticket Priority Distribution',
                    font: { size: 18, weight: 'bold' },
                    color: '#1f2937'
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    bodyColor: '#fff',
                    titleColor: '#fff'
                }
            }
        }
    });

    new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: statusColors,
                borderColor: '#ffffff',
                borderWidth: 3 // Slightly thicker border for slices
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { font: { size: 13 }, color: '#374151', padding: 15 }
                },
                title: {
                    display: true,
                    text: 'Ticket Status Distribution',
                    font: { size: 18, weight: 'bold' },
                    color: '#1f2937'
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    bodyColor: '#fff',
                    titleColor: '#fff'
                }
            }
        }
    });
</script>
{% endblock %}