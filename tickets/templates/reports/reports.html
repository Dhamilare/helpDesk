{% extends 'base.html' %}
{% load static %}

{% block title %}Reports{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-gray-800 mb-6">Reports and Analytics</h2>
<hr class="mb-8 border-gray-300">

<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <form method="get" class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4">
        <div class="w-full md:w-1/4">
            <label for="id_date_from" class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
            <input type="date" name="date_from" id="id_date_from"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                   value="{{ date_from|date:'Y-m-d' }}">
        </div>
        <div class="w-full md:w-1/4">
            <label for="id_date_to" class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
            <input type="date" name="date_to" id="id_date_to"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                   value="{{ date_to|date:'Y-m-d' }}">
        </div>
        <div class="flex items-center space-x-3">
            <button type="submit"
                    class="px-4 py-2 text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                <i data-lucide="filter" class="h-4 w-4 mr-2"></i> Apply Date Filter
            </button>
            <a href="{% url 'reports' %}"
               class="px-4 py-2 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white border border-gray-300 hover:bg-gray-50">
                <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i> Reset Dates
            </a>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-blue-600 rounded-lg shadow-md p-6 text-white flex items-center justify-between">
        <div>
            <h5 class="text-lg font-medium opacity-90">Total Tickets</h5>
            <p class="text-4xl font-bold mt-2">{{ total_tickets }}</p>
        </div>
        <i data-lucide="ticket" class="h-12 w-12 opacity-75"></i>
    </div>
    <div class="bg-green-600 rounded-lg shadow-md p-6 text-white flex items-center justify-between">
        <div>
            <h5 class="text-lg font-medium opacity-90">Resolved Tickets</h5>
            <p class="text-4xl font-bold mt-2">{{ resolved_tickets }}</p>
        </div>
        <i data-lucide="check-circle" class="h-12 w-12 opacity-75"></i>
    </div>
    <div class="bg-gray-600 rounded-lg shadow-md p-6 text-white flex items-center justify-between">
        <div>
            <h5 class="text-lg font-medium opacity-90">Closed Tickets</h5>
            <p class="text-4xl font-bold mt-2">{{ closed_tickets }}</p>
        </div>
        <i data-lucide="folder-check" class="h-12 w-12 opacity-75"></i>
    </div>
    <div class="bg-red-600 rounded-lg shadow-md p-6 text-white flex items-center justify-between">
        <div>
            <h5 class="text-lg font-medium opacity-90">Overdue Tickets</h5>
            <p class="text-4xl font-bold mt-2">{{ overdue_tickets }}</p>
        </div>
        <i data-lucide="clock" class="h-12 w-12 opacity-75"></i>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h5 class="text-lg font-semibold text-gray-700">Resolution Rate</h5>
        </div>
        <div class="p-6 text-center">
            <p class="text-5xl font-bold text-blue-700">{{ resolution_rate }}<span class="text-3xl">%</span></p>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gray-100 px-6 py-4 border-b border-gray-200">
            <h5 class="text-lg font-semibold text-gray-700">Average Resolution Time</h5>
        </div>
        <div class="p-6 text-center">
            <p class="text-5xl font-bold text-green-700">
                {% if avg_resolution_time %}
                    {{ avg_resolution_time }} <span class="text-3xl">hours</span>
                {% else %}
                    N/A
                {% endif %}
            </p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Tickets by Department</h3>
        <div class="relative w-full h-80">
            <canvas id="deptChart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Tickets by Priority</h3>
        <div class="relative w-full h-80">
            <canvas id="priorityChart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Tickets by Status</h3>
        <div class="relative w-full h-80">
            <canvas id="statusChart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Top 10 Agents by Resolved Tickets</h3>
        {% if agent_stats %}
            <ul class="divide-y divide-gray-200 border-t border-b border-gray-200">
                {% for stat in agent_stats %}
                    <li class="flex justify-between items-center py-3">
                        <span class="text-gray-800 font-medium">{{ stat.assigned_to__first_name }} {{ stat.assigned_to__last_name }}</span>
                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ stat.count }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600">No agent resolution data available.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
<script>
    lucide.createIcons();

    const deptLabels = [{% for stat in dept_stats %}'{{ stat.department__name|default:"N/A" }}',{% endfor %}];
    const deptData = [{% for stat in dept_stats %}{{ stat.count }},{% endfor %}];

    const priorityLabels = [{% for stat in priority_stats %}'{{ stat.priority__name }}',{% endfor %}];
    const priorityData = [{% for stat in priority_stats %}{{ stat.count }},{% endfor %}];
    const priorityColors = [{% for stat in priority_stats %}'{{ stat.priority__color }}',{% endfor %}];

    const statusLabels = [{% for stat in status_stats %}'{{ stat.status|capfirst }}',{% endfor %}];
    const statusData = [{% for stat in status_stats %}{{ stat.count }},{% endfor %}];
    const statusColors = ['#FCD34D', '#67E8F9', '#86EFAC', '#D1D5DB', '#FCA5A5'];

    new Chart(document.getElementById('deptChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: deptLabels,
            datasets: [{
                label: 'Tickets by Department',
                data: deptData,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Tickets by Department',
                    font: { size: 16 },
                    color: '#374151'
                }
            }
        }
    });

    new Chart(document.getElementById('priorityChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: priorityLabels,
            datasets: [{
                data: priorityData,
                backgroundColor: priorityColors,
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { font: { size: 12 }, color: '#374151' }
                },
                title: {
                    display: true,
                    text: 'Ticket Priority Distribution',
                    font: { size: 16 },
                    color: '#374151'
                }
            }
        }
    });

    new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: statusColors,
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { font: { size: 12 }, color: '#374151' }
                },
                title: {
                    display: true,
                    text: 'Ticket Status Distribution',
                    font: { size: 16 },
                    color: '#374151'
                }
            }
        }
    });
</script>
{% endblock %}
