{% extends 'base.html' %}
{% load static %} {# Make sure you load static files if you use any for images/icons #}

{% block title %}Knowledge Base{% endblock %}

{% block content %}
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Knowledge Base</h2>
    <hr class="mb-8 border-gray-300">

    {# Search and Filter Form #}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <form method="get" class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4">
            <div class="w-full md:w-1/3">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <div class="relative">
                    <input type="text" name="search" id="search"
                           class="mt-1 block w-full pl-10 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                           value="{{ search_query|default_if_none:'' }}" placeholder="Search articles...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/4">
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select name="category" id="category"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.pk }}" {% if cat.pk|stringformat:"s" == selected_category %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center space-x-3 mt-auto"> {# mt-auto pushes these buttons to the bottom if content above is taller #}
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i data-lucide="search" class="h-4 w-4 mr-2"></i> Search
                </button>
                <a href="{% url 'kb_list' %}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i> Reset
                </a>
            </div>
            {# FIX APPLIED HERE #}
            {% if user.is_authenticated %}
                {% if user.userprofile.is_agent or user.userprofile.is_supervisor %}
                    <div class="w-full md:w-auto md:ml-auto mt-4 md:mt-auto"> {# ms-auto in Bootstrap is ml-auto in Tailwind #}
                        <a href="{% url 'kb_create' %}"
                           class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i> Create New Article
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        </form>
    </div>

    {# Articles List #}
    {% if articles %}
        <div class="bg-white rounded-lg shadow-md divide-y divide-gray-200">
            {% for article in articles %}
                <a href="{% url 'kb_detail' article.pk %}" class="block px-6 py-4 hover:bg-gray-50 transition duration-150 ease-in-out">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2">
                        <h5 class="text-lg font-semibold text-gray-900">{{ article.title }}</h5>
                        <small class="text-gray-500 text-sm mt-1 sm:mt-0">{{ article.created_at|date:"Y-m-d" }}</small>
                    </div>
                    <p class="text-gray-700 mb-2 text-sm leading-relaxed">{{ article.content|striptags|truncatechars:150 }}</p>
                    <small class="text-gray-500 text-xs">
                        Category: <span class="font-medium text-gray-600">{{ article.category.name }}</span> |
                        Views: <span class="font-medium text-gray-600">{{ article.views }}</span>
                    </small>
                </a>
            {% endfor %}
        </div>

        {# Pagination #}
        {% if is_paginated %}
            <nav class="mt-8 flex justify-center" aria-label="Page navigation">
                <ul class="flex items-center space-x-2">
                    {% if page_obj.has_previous %}
                        <li>
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Previous
                            </a>
                        </li>
                    {% endif %}
                    <li>
                        <span class="relative inline-flex items-center px-4 py-2 border border-blue-500 text-sm font-semibold rounded-md text-white bg-blue-600">
                            {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    {% if page_obj.has_next %}
                        <li>
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Next
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <p class="text-gray-600 text-center py-8 bg-white rounded-lg shadow-md">No knowledge base articles found.</p>
    {% endif %}
{% endblock %}

{% block extra_js %}
    {# Include Lucide Icons script here #}
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
{% endblock %}